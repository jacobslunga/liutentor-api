import { Hono } from "hono";
import { HTTPException } from "hono/http-exception";
import { cors } from "hono/cors";
import { supabaseMiddleware } from "~/db/supabase";
import exams from "~/api/v1/exams.routes";
import chat from "~/api/v1/chat.routes";
import { fail } from "~/utils/response";
import { rateLimit } from "~/middleware/ratelimit";

const app = new Hono().basePath("/api");

app.use(
  cors({
    origin: ["http://localhost:5173", "https://liutentor.se"],
  }),
);

app.onError((err, c) => {
  if (err instanceof HTTPException) {
    return c.json(fail(err.message), err.status);
  }

  console.error(err);

  return c.json(fail("Internal server error"), 500);
});

app.use(supabaseMiddleware);
app.use("/v1/exams/*", rateLimit);

app.route("/", exams);
app.route("/", chat);

export default {
  port: process.env.PORT || 3000,
  fetch: app.fetch,
  idleTimeout: 120,
};
